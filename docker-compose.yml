x-php-fpm-template: &php-template
    restart: unless-stopped
    working_dir: /var/www
    depends_on:
        - db
        - php-fpm-base
        - rabbitmq
    build: &php-template-build
        context: ./
        dockerfile: ./docker/images/php/Dockerfile
services:
    php-fpm-base:
        container_name: task_manager-php-base
        image: task_manager-php-base
        build:
            context: ./
            dockerfile: ./docker/images/php/Dockerfile-base
        command: "exit 0"
    rabbitmq:
        container_name: task_manager-rabbitmq
        image: 'rabbitmq:3.10.5-management'
        restart: unless-stopped
        ports:
            - "5672:5672"
            - "15672:15672"
    php-fpm-projects:
        <<: *php-template
        container_name: task_manager-php-projects
        build:
            <<: *php-template-build
            args:
                COMMON_NAME: projects
                HTTP_SERVER_PORT: 8080
        volumes:
            - ./app/src/Shared:/var/www/src/Shared
            - ./app/symfony:/var/www/symfony
            - ./app/config/shared:/var/www/config/shared
            - ./app/src/Projects:/var/www/src/Projects
            - ./app/config/project:/var/www/config/app
        ports:
            - '8080:8080'
    php-fpm-users:
        <<: *php-template
        container_name: task_manager-php-users
        build:
            <<: *php-template-build
            args:
                COMMON_NAME: users
                HTTP_SERVER_PORT: 8081
        volumes:
            - ./app/src/Shared:/var/www/src/Shared
            - ./app/symfony:/var/www/symfony
            - ./app/config/shared:/var/www/config/shared
            - ./app/src/Users:/var/www/src/Users
            - ./app/config/user:/var/www/config/app
        ports:
            - '8081:8081'
    php-fpm-requests:
        <<: *php-template
        container_name: task_manager-php-requests
        build:
            <<: *php-template-build
            args:
                COMMON_NAME: requests
                HTTP_SERVER_PORT: 8082
        volumes:
            - ./app/src/Shared:/var/www/src/Shared
            - ./app/symfony:/var/www/symfony
            - ./app/config/shared:/var/www/config/shared
            - ./app/src/Requests:/var/www/src/Requests
            - ./app/config/request:/var/www/config/app
        ports:
            - '8082:8082'
    php-fpm-tasks:
        <<: *php-template
        container_name: task_manager-php-tasks
        build:
            <<: *php-template-build
            args:
                COMMON_NAME: tasks
                HTTP_SERVER_PORT: 8083
        volumes:
            - ./app/src/Shared:/var/www/src/Shared
            - ./app/symfony:/var/www/symfony
            - ./app/config/shared:/var/www/config/shared
            - ./app/src/Tasks:/var/www/src/Tasks
            - ./app/config/task:/var/www/config/app
        ports:
            - '8083:8083'
    db:
        container_name: task_manager-db
        image: postgres:14.2-alpine3.15
        restart: always
        environment:
            POSTGRES_USER: symfony
            POSTGRES_PASSWORD: symfony
        ports:
            - '5432:5432'
        volumes:
            - ./data/db:/var/lib/postgresql/data
            - ./logs/db:/var/log/nginx
    adminer:
        container_name: task_manager-adminer
        image: adminer:latest
        restart: always
        ports:
            - '9080:8080'